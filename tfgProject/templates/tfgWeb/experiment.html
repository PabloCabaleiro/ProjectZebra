{% extends "tfgWeb/base.html" %}
{% load staticfiles %}

{% block title_block %}
{% endblock %}

{% block body_block %}
        <div class="info-forms" >
            {% if series %}
                <form id="info_form" method="post" action="/experiment/" enctype= multipart/form-dat>
                    {% csrf_token %}
                    Vista:
                    <select id="vistas" onchange="handleInfoSubmit()" name="view" >
                        {% for view in views_list %}
                            <option  value={{ view }} {% if view == selected_view %}selected{% endif %}> {{ view }} </option>
                        {% endfor %}
                    </select>
                    {% if selected_view == 'BRAIN'  %}
                        Series:
                    {% endif %}
                    <select id="series" {% if   selected_view != 'BRAIN' %} hidden {% endif %} onchange="handleInfoSubmit()" name="serie" >
                        {% for serie in series %}
                            <option  value={{ serie.id }} {% if serie.id == selected_serie.id %}selected{% endif %}> {{ serie.name }} </option>
                        {% endfor %}
                    </select>
                    {% if selected_view != 'BRAIN' %}
                    Atlas:
                    {% endif %}
                    <select id="atlas" onchange="handleInfoSubmit()" {% if selected_view == 'BRAIN' %} hidden {% endif %} name="atlas" >
                        {% for atlas in atlas_list %}
                            <option value={{ atlas.id }} {% if atlas.id == selected_atlas.id %}selected{% endif %}> {{ atlas.name }} </option>
                        {% endfor %}
                    </select>
                    {% if total_times > 0 %}
                        Time: <input name="time" type="number" value= {{ time }}  min="0" onchange="this.form.submit()" />
                    {% else %}
                         <input name="time" hidden type="number" value= {{ time }} max= {{ total_times }} min="0" onchange="this.form.submit()" />
                    {% endif %}
                    <input id = "pos_x" hidden type="text" name="pos_x" value= {{ pos_x }} size="5" />
                    <input id = "pos_y" hidden type="text" name="pos_y" value= {{ pos_y }} size="5" />
                    <input id = "pos_z" hidden type="text" name="pos_z" value= {{ pos_z }} size="5" />
                    <input id = "pos_x_atlas" hidden type="text" name="pos_x_atlas" value= {{ pos_x_atlas }} size="5" />
                    <input id = "pos_y_atlas" hidden type="text" name="pos_y_atlas" value= {{ pos_y_atlas }} size="5" />
                    <input id = "pos_z_atlas" hidden type="text" name="pos_z_atlas" value= {{ pos_z_atlas }} size="5" />
                    <input id = "pos_x_start" hidden type="text" name="pos_x_start" value= {{ pos_x_start }} />
                    <input id = "pos_y_start" hidden type="text" name="pos_y_start" value= {{ pos_y_start }} />
                    <input id = "pos_z_start" hidden type="text" name="pos_z_start" value= {{ pos_z_start }} />
                    <input id = "width" hidden type="text" name="width" value= {{ width }} />
                    <input id = "height" hidden type="text" name="height" value= {{ height }} />
                    <input id = "depth" hidden type="text" name="depth" value= {{ depth }} />
                    <input name = "save" hidden value = "0" id="save">
                    <input name = "navigate" id="navigate" value = {{navigate}} hidden />
                    <button onclick="changeMode()" id="change_mode" {% if selected_view != 'SYNC' %}hidden {% endif %}>{% if navigate == 1 %} Modify synchronization {% else %} Save and Explore {% endif %}</button>
                </form>
            {% endif %}
        </div>
        <br>
        <div class="canvas">
            {% if top_image or top_atlas %}
                <canvas title="Top image" id="canvas_top" width= {{ canvas_size_z }} height= {{ canvas_size_x }} ></canvas>
            {% endif %}
            {% if front_image or front_atlas %}
                <canvas title= "Front image" id="canvas_front" width= {{ canvas_size_x }} height= {{ canvas_size_y }} ></canvas>
            {% endif %}
            {% if side_image or side_atlas %}
                <canvas title="Side image" id="canvas_side" width= {{ canvas_size_z }} height= {{ canvas_size_y }} ></canvas>
            {% endif %}
            <script>

                var canvas_top;
                var ctx_top;
                var canvas_front;
                var ctx_front;
                var canvas_sides;
                var ctx_side;

                var img_top;
                var img_front;
                var img_side;

                var startX;
                var startY;
                var startZ;
                var isDown=false;

                var pos_x = {{ pos_x }};
                var pos_y = {{ pos_y }};
                var pos_z = {{ pos_z }};

                var pos_x_atlas = {{ pos_x_atlas }};
                var pos_y_atlas = {{ pos_y_atlas }};
                var pos_z_atlas = {{ pos_z_atlas }};

                var prop_x = pos_x;
                var prop_y = pos_y;
                var prop_z = pos_z;

                var pi2=Math.PI*2;
                var resizerRadius=4;
                var rr=resizerRadius*resizerRadius;
                var draggingResizer={x:0,y:0};

                var imageX= {{ pos_x_start }};
                var imageY={{ pos_y_start }};
                var imageZ={{ pos_z_start }};

                var imageWidth = {{ width }};
                var imageHeight = {{ height }};
                var imageDepth = {{ depth }};

                var pos_x_form = document.getElementById('pos_x');
                var pos_y_form = document.getElementById('pos_y');
                var pos_z_form = document.getElementById('pos_z');
                var pos_x_atlas_form = document.getElementById('pos_x_atlas');
                var pos_y_atlas_form = document.getElementById('pos_y_atlas');
                var pos_z_atlas_form = document.getElementById('pos_z_atlas');
                var pos_x_start = document.getElementById('pos_x_start');
                var pos_y_start = document.getElementById('pos_y_start');
                var pos_z_start = document.getElementById('pos_z_start');
                var width_form = document.getElementById('width');
                var height_form = document.getElementById('height');
                var depth_form = document.getElementById('depth');
                var info_form = document.getElementById('info_form');
                var save = document.getElementById('save');
                var navigate = document.getElementById('navigate');


                var lastImageWidth = imageWidth;
                var lastImageHeight = imageHeight;
                var lastImageDepth = imageDepth;

                var imageRight, imageBottom, imageBack;
                var draggingImage=false;
                var down = false;
                var hit = false;

                var offsetXFront;
                var offsetYFront;
                var offsetXTop;
                var offsetYTop;
                var offsetXSide;
                var offsetYSide;

                window.onload=function() {

                    canvas_top = document.getElementById('canvas_top');
                    ctx_top = canvas_top.getContext("2d");
                    canvas_front = document.getElementById('canvas_front');
                    ctx_front = canvas_front.getContext("2d");
                    canvas_side = document.getElementById('canvas_side');
                    ctx_side = canvas_side.getContext("2d");

                    offsetXFront=canvas_front.offsetLeft;
                    offsetYFront=canvas_front.offsetTop;
                    offsetXTop=canvas_top.offsetLeft;
                    offsetYTop=canvas_top.offsetTop;
                    offsetXSide=canvas_side.offsetLeft;
                    offsetYSide=canvas_side.offsetTop;

                    {% if selected_view == 'SYNC' and navigate < 1 %}
                        canvas_front.addEventListener('mousedown',handleMouseDownFront);
                        canvas_front.addEventListener('mousemove',handleMouseMoveFront);
                        canvas_front.addEventListener('mouseup',handleMouseUpFront);
                        canvas_front.addEventListener('mouseout',handleMouseOutFront);

                        canvas_side.addEventListener('mousedown',handleMouseDownSide);
                        canvas_side.addEventListener('mousemove',handleMouseMoveSide);
                        canvas_side.addEventListener('mouseup',handleMouseUpSide);
                        canvas_side.addEventListener('mouseout',handleMouseOutSide);

                        canvas_top.addEventListener('mousedown',handleMouseDownTop);
                        canvas_top.addEventListener('mousemove',handleMouseMoveTop);
                        canvas_top.addEventListener('mouseup',handleMouseUpTop);
                        canvas_top.addEventListener('mouseout',handleMouseOutTop);
                    {% else %}
                        canvas_front.addEventListener('click',handleClickFront);
                        canvas_side.addEventListener('click',handleClickSide);
                        canvas_top.addEventListener('click',handleClickTop);
                    {% endif %}

                    {% if selected_view == 'BRAIN' or front_image %}
                        img_top = new Image();
                        img_top.onload=function(){
                            imageBack=imageZ+imageDepth;
                            imageRight=imageX+imageWidth;
                            draw();
                        };

                        img_side=new Image();
                        img_side.onload=function(){
                            imageBack=imageZ+imageDepth;
                            imageBottom=imageY+imageHeight
                            draw();
                        };

                        img_front=new Image();
                        img_front.onload=function(){
                            imageRight=imageX+imageWidth;
                            imageBottom=imageY+imageHeight
                            draw();
                        };

                        img_front.src= "{{ front_image }}";
                        img_side.src= "{{ side_image }}";
                        img_top.src= "{{ top_image }}";
                    {% endif %}

                    {% if selected_view == 'ATLAS' or selected_view == 'SYNC' %}
                        atlas_top = new Image();
                        atlas_side=new Image();
                        atlas_front=new Image();
                        atlas_top.onload=function(){
                            draw();
                        };
                        atlas_side.onload=function(){
                            draw();
                        };
                        atlas_front.onload=function(){
                            draw();
                        };
                        atlas_front.src= "{{front_atlas }}";
                        atlas_side.src= "{{side_atlas }}";
                        atlas_top.src= "{{top_atlas }}";
                    {% endif %}
                }

                function changeMode() {
                    if ({{navigate}} == -1) {
                        width_form.value = imageWidth;
                        height_form.value = imageHeight;
                        depth_form.value = imageDepth;
                        pos_x_start.value = imageX;
                        pos_y_start.value = imageY;
                        pos_z_start.value = imageZ;
                        save.value=1;
                        navigate.value=1;
                    } else {
                        save.value=0;
                        navigate.value=-1;
                        pos_x_atlas_form.value = pos_x_atlas;
                        pos_y_atlas_form.value = pos_y_atlas;
                        pos_z_atlas_form.value = pos_z_atlas;
                        pos_x_form.value = pos_x;
                        pos_y_form.value = pos_y;
                        pos_z_form.value = pos_z;
                    }
                    info_form.submit();
                }

                function writeMessage(context, canvas, message) {
                    context.globalCompositeOperation = 'source-over';
                    context.font = '14pt Calibri';
                    context.fillStyle = 'red';
                    context.fillText(message, 10, 25);
                }

                function handleInfoSubmit() {
                    pos_x_start.value = imageX;
                    pos_z_start.value = imageZ;
                    pos_y_start.value = imageY;
                    width_form.value = imageWidth;
                    height_form.value = imageHeight;
                    depth_form.value = imageDepth;
                    info_form.submit();

                }

                function getMousePos(canvas, e) {
                    var rect = canvas.getBoundingClientRect();
                    return {
                      x: mouseX=parseInt(e.clientX-offsetXFront),
                      y: parseInt(e.clientY-offsetYFront)
                    };
                }

                function draw(){

                    //clean the canvas
                    ctx_front.clearRect(0,0,{{ canvas_size_x }},{{ canvas_size_y }});
                    ctx_top.clearRect(0,0,{{ canvas_size_z }},{{ canvas_size_x }});
                    ctx_side.clearRect(0,0,{{ canvas_size_z }},{{ canvas_size_y }});

                    // draw the images
                    //FRONT
                    {% if selected_view != 'BRAIN' %}
                        ctx_front.globalCompositeOperation = 'destination-over';
                        ctx_front.drawImage(atlas_front, 0, 0,atlas_front.width,atlas_front.height,0,0,{{ canvas_size_x }},{{ canvas_size_y }});
                    {% endif %}
                    {% if selected_view != 'ATLAS' %}
                        ctx_front.globalCompositeOperation = 'source-over';
                        {% if selected_view == 'SYNC' and front_image %}
                            ctx_front.drawImage(img_front,0,0,img_front.width,img_front.height,imageX,imageY,imageWidth,imageHeight);
                        {% elif selected_view == 'BRAIN' %}
                            ctx_front.drawImage(img_front,0,0,img_front.width,img_front.height,imageX,imageY,{{canvas_size_x}},{{ canvas_size_y }});
                        {% endif %}
                    {% endif %}
                    {% if selected_view == 'SYNC' and navigate == -1 %}
                        // draw the connecting anchor lines
                        ctx_front.strokeStyle = "#0f0";
                        ctx_front.beginPath();
                        ctx_front.moveTo(imageX,imageY);
                        ctx_front.lineTo(imageRight,imageY);
                        ctx_front.lineTo(imageRight,imageBottom);
                        ctx_front.lineTo(imageX,imageBottom);
                        ctx_front.lineTo(imageX,imageY);
                        ctx_front.stroke();
                        ctx_front.closePath();
                        // draw the draggable anchors
                        drawDragAnchor('FRONT',imageX,imageY);
                        drawDragAnchor('FRONT',imageRight,imageY);
                        drawDragAnchor('FRONT',imageRight,imageBottom);
                        drawDragAnchor('FRONT',imageX,imageBottom);
                        var message = 'Front image: ' +{{pos_x}} + 'x, ' + {{pos_y}} +'y Atlas image: ' + {{pos_x_atlas}} + 'x, ' + {{pos_y_atlas}} + 'y'
                    {% elif selected_view == 'SYNC' and navigate == 1 %}
                        var message = 'Front image: ' +{{pos_x}} + 'x, ' + {{pos_y}} +'y Atlas image: ' + {{pos_x_atlas}} + 'x, ' + {{pos_y_atlas}} + 'y'
                    {% endif %}

                    {% if selected_view == 'ATLAS' %}
                        var message = 'Atlas front: ' + {{pos_x_atlas}} + 'x, ' + {{pos_y_atlas}} + 'y'
                    {% elif selected_view == 'BRAIN' %}
                        var message = 'Front image: ' +{{pos_x}} + 'x, ' + {{pos_y}} +'y'
                    {% endif %}

                    ctx_front.font = '10pt Calibri';
                    ctx_front.fillStyle = 'red';
                    ctx_front.fillText(message, 5, 15);


                    //TOP
                    {% if selected_view != 'BRAIN' %}
                        ctx_top.globalCompositeOperation = 'destination-over';
                        ctx_top.drawImage(atlas_top, 0, 0,atlas_top.width,atlas_top.height,0,0,{{ canvas_size_z }},{{ canvas_size_x }});
                    {% endif %}
                    {% if selected_view != 'ATLAS' %}
                        ctx_top.globalCompositeOperation = 'source-over';
                        {% if selected_view == 'SYNC' and top_image %}
                            ctx_top.drawImage(img_top,0,0,img_top.width,img_top.height,{{canvas_size_z}} - (imageZ + imageDepth),imageX,imageDepth,imageWidth);
                        {% elif selected_view == 'BRAIN' %}
                            ctx_top.drawImage(img_top,0,0,img_top.width,img_top.height,imageZ,imageX,{{ canvas_size_z }},{{ canvas_size_x }});
                        {% endif %}
                    {% endif %}
                    {% if selected_view == 'SYNC' and navigate == -1 %}
                        // draw the connecting anchor lines
                        ctx_top.strokeStyle = "#0f0";
                        ctx_top.beginPath();
                        ctx_top.moveTo({{canvas_size_z}} - (imageZ + imageDepth),imageX);
                        ctx_top.lineTo({{canvas_size_z}} - imageZ,imageX);
                        ctx_top.lineTo({{canvas_size_z}} - imageZ,imageRight);
                        ctx_top.lineTo({{canvas_size_z}} - (imageZ + imageDepth),imageRight);
                        ctx_top.lineTo({{canvas_size_z}} - (imageZ + imageDepth),imageX);
                        ctx_top.stroke();
                        ctx_top.closePath();
                        // draw the draggable anchors
                        drawDragAnchor('TOP',{{canvas_size_z}} - (imageZ + imageDepth),imageX);
                        drawDragAnchor('TOP',{{canvas_size_z}} - imageZ,imageX);
                        drawDragAnchor('TOP',{{canvas_size_z}} - imageZ,imageRight);
                        drawDragAnchor('TOP',{{canvas_size_z}} - (imageZ + imageDepth),imageRight);
                    {% endif %}
                    {% if selected_view == 'SYNC' %}
                        var message = 'Top image: ' + {{pos_z}} + 'z, ' + {{pos_x}} +'x Atlas image: ' + {{pos_z_atlas}} + 'z, ' + {{pos_x_atlas}} + 'x'
                    {% elif selected_view == 'ATLAS' %}
                        var message = 'Atlas top: ' + {{pos_z_atlas}} + 'z, ' + {{pos_x_atlas}} + 'x'
                    {% elif selected_view == 'BRAIN' %}
                        var message = 'Top image: ' + {{pos_z}} + 'z, ' + {{pos_x}} +'x'
                    {% endif %}
                    ctx_top.font = '10pt Calibri';
                    ctx_top.fillStyle = 'red';
                    ctx_top.fillText(message, 5, 15);

                    //SIDE
                    {% if selected_view != 'BRAIN' %}
                        ctx_side.globalCompositeOperation = 'destination-over';
                        ctx_side.drawImage(atlas_side, 0, 0,atlas_side.width,atlas_side.height,0,0,{{ canvas_size_z }},{{ canvas_size_y }});
                    {% endif %}
                    {% if selected_view != 'ATLAS' %}
                        ctx_side.globalCompositeOperation = 'source-over';
                        {% if selected_view == 'SYNC' and side_image %}
                            ctx_side.drawImage(img_side,0,0,img_side.width,img_side.height,imageZ,imageY,imageDepth,imageHeight);
                        {% elif selected_view == 'BRAIN' %}
                            ctx_side.drawImage(img_side,0,0,img_side.width,img_side.height,imageZ,imageY,{{ canvas_size_z }},{{ canvas_size_y }});
                        {% endif %}
                    {% endif %}
                    {% if selected_view == 'SYNC' and navigate == -1 %}
                        // draw the connecting anchor lines
                        ctx_side.beginPath();
                        ctx_side.strokeStyle = "#0f0";
                        ctx_side.moveTo(imageZ,imageY);
                        ctx_side.lineTo(imageBack,imageY);
                        ctx_side.lineTo(imageBack,imageBottom);
                        ctx_side.lineTo(imageZ,imageBottom);
                        ctx_side.lineTo(imageZ,imageY);
                        ctx_side.stroke();
                        ctx_side.closePath();
                        // draw the draggable anchors
                        drawDragAnchor('SIDE',imageZ,imageY);
                        drawDragAnchor('SIDE',imageBack,imageY);
                        drawDragAnchor('SIDE',imageBack,imageBottom);
                        drawDragAnchor('SIDE',imageZ,imageBottom);
                    {% endif %}
                    {% if selected_view == 'SYNC' %}
                        var message = 'Side image: ' + {{pos_z}} + 'z, ' + {{pos_y}} +'y Atlas image: ' + {{pos_z_atlas}} + 'z, ' + {{pos_y_atlas}} + 'y';
                    {% elif selected_view == 'ATLAS' %}
                        var message = 'Atlas side: ' + {{pos_z_atlas}} + 'z, ' + {{pos_y_atlas}} + 'y';
                    {% elif selected_view == 'BRAIN' %}
                        var message = 'Side image: ' + {{pos_z}} + 'z, ' + {{pos_y}} +'y';
                    {% endif %}
                    ctx_side.font = '10pt Calibri';
                    ctx_side.fillStyle = 'red';
                    ctx_side.fillText(message, 5, 15);

                    // draw position lines
                    {% if selected_view != 'SYNC' or navigate == 1 %}
                        drawLines();
                    {% endif %}
                }

                function drawDragAnchor(img,x,y){
                    if (img == 'FRONT') {
                        ctx_front.globalCompositeOperation = 'source-over';
                        ctx_front.beginPath();
                        ctx_front.fillStyle = "#f00";
                        ctx_front.arc(x,y,resizerRadius,0,pi2,false);
                        ctx_front.fill();
                        ctx_front.closePath();
                    } else if (img == 'TOP') {
                        ctx_top.globalCompositeOperation = 'source-over';
                        ctx_top.beginPath();
                        ctx_top.fillStyle = "#f00";
                        ctx_top.arc(x,y,resizerRadius,0,pi2,false);
                        ctx_top.fill();
                        ctx_top.closePath();
                    } else if (img == 'SIDE') {
                        ctx_side.globalCompositeOperation = 'source-over';
                        ctx_side.beginPath();
                        ctx_side.fillStyle = "#f00";
                        ctx_side.arc(x,y,resizerRadius,0,pi2,false);
                        ctx_side.fill();
                        ctx_side.closePath();
                    }
                }

                function drawLines() {
                    {% if selected_view == 'BRAIN' %}
                        var aux_x = pos_x;
                        var aux_y = pos_y;
                        var aux_z = pos_z;
                    {% else %}
                        var aux_x = pos_x_atlas;
                        var aux_y = pos_y_atlas;
                        var aux_z =pos_z_atlas;
                    {% endif %}
                    //FRONT LINES
                    ctx_front.globalCompositeOperation = 'source-over';
                    ctx_front.beginPath();
                    ctx_front.strokeStyle = "#f00";
                    ctx_front.moveTo(0,aux_y);
                    ctx_front.lineTo({{canvas_size_x}},aux_y);
                    ctx_front.moveTo(aux_x,0);
                    ctx_front.lineTo(aux_x,{{canvas_size_y}});
                    ctx_front.stroke();
                    ctx_front.closePath();
                    //SIDE LINES
                    ctx_side.globalCompositeOperation = 'source-over';
                    ctx_side.beginPath();
                    ctx_side.strokeStyle = "#f00";
                    ctx_side.moveTo(0,aux_y);
                    ctx_side.lineTo({{canvas_size_z}},aux_y);
                    ctx_side.moveTo(aux_z,0);
                    ctx_side.lineTo(aux_z,{{canvas_size_y}});
                    ctx_side.stroke();
                    ctx_side.closePath();
                    //TOP LINES
                    ctx_top.globalCompositeOperation = 'source-over';
                    ctx_top.beginPath();
                    ctx_top.strokeStyle = "#f00";
                    ctx_top.moveTo({{canvas_size_z}}-aux_z,0);
                    ctx_top.lineTo({{canvas_size_z}}-aux_z,{{canvas_size_x}});
                    ctx_top.moveTo(0,aux_x);
                    ctx_top.lineTo({{canvas_size_z}},aux_x);
                    ctx_top.stroke();
                    ctx_top.closePath();
                }

                function anchorHitTest(img,x,y){

                    if (img == 'FRONT') {
                        var dx,dy;
                        // top-left
                        dx=x-imageX;
                        dy=y-imageY;
                        if(dx*dx+dy*dy<=rr){ return(0); }
                        // top-right
                        dx=x-imageRight;
                        dy=y-imageY;
                        if(dx*dx+dy*dy<=rr){ return(1); }
                        // bottom-right
                        dx=x-imageRight;
                        dy=y-imageBottom;
                        if(dx*dx+dy*dy<=rr){ return(2); }
                        // bottom-left
                        dx=x-imageX;
                        dy=y-imageBottom;
                        if(dx*dx+dy*dy<=rr){ return(3); }
                        return(-1);
                    } else if (img == 'SIDE') {
                        var dz,dy;
                        // top-left
                        dz=x-imageZ;
                        dy=y-imageY;
                        if(dz*dz+dy*dy<=rr){ return(0); }
                        // top-right
                        dz=x-imageBack;
                        dy=y-imageY;
                        if(dz*dz+dy*dy<=rr){ return(1); }
                        // bottom-right
                        dz=x-imageBack;
                        dy=y-imageBottom;
                        if(dz*dz+dy*dy<=rr){ return(2); }
                        // bottom-left
                        dz=x-imageZ;
                        dy=y-imageBottom;
                        if(dz*dz+dy*dy<=rr){ return(3); }
                        return(-1);
                    } else if (img == 'TOP') {
                        var dx,dz;
                        // top-left
                        dx= x- ({{canvas_size_z}} - (imageZ+ imageDepth));
                        dz=y-imageX;
                        if(dx*dx+dz*dz<=rr){ return(0); }
                        // top-right
                        dx=x-({{canvas_size_z}} - imageZ);
                        dz=y-imageX;
                        if(dx*dx+dz*dz<=rr){ return(1); }
                        // bottom-right
                        dx=x- ({{canvas_size_z}}- imageZ);
                        dz=y-imageRight;
                        if(dx*dx+dz*dz<=rr){ return(2); }
                        // bottom-left
                        dx=x- ({{canvas_size_z}} - (imageZ+ imageDepth));
                        dz=y-imageRight;
                        if(dx*dx+dz*dz<=rr){ return(3); }
                        return(-1);
                    }

                }


                function hitImage(img,x,y){
                    if (img == 'FRONT') {
                        return(x>imageX && x<imageX+imageWidth && y>imageY && y<imageY+imageHeight);
                    } else if (img == 'SIDE') {
                        return(x>imageZ && x<imageZ+imageDepth && y>imageY && y<imageY+imageHeight);
                    } else if (img == 'TOP') {
                        return(x>({{canvas_size_z}} - (imageZ+ imageDepth)) && x<({{canvas_size_z}} - imageZ) && y>imageX && y<imageZ+imageWidth);
                    }
                }


                function handleMouseDownFront(e){
                  var rect = canvas_front.getBoundingClientRect();
                  startX=parseInt(e.clientX-offsetXFront);
                  startY=parseInt(e.clientY-offsetYFront);
                  draggingResizer=anchorHitTest('FRONT',startX,startY);
                  hit = hitImage('FRONT',startX,startY);
                  down = draggingResizer<0 && hit;
                }

                function handleMouseDownSide(e){
                  var rect = canvas_side.getBoundingClientRect();
                  startZ=Math.round((e.clientX-rect.left)/(rect.right-rect.left)*{{canvas_size_z}});
                  startY=Math.round((e.clientY-rect.top)/(rect.bottom-rect.top)*{{canvas_size_y}});
                  draggingResizer=anchorHitTest('SIDE',startZ,startY);
                  hit = hitImage('SIDE',startZ,startY);
                  down = draggingResizer<0 && hit;
                }

                function handleMouseDownTop(e){
                  var rect = canvas_top.getBoundingClientRect();
                  startZ=Math.round((e.clientX-rect.left)/(rect.right-rect.left)*{{canvas_size_z}});
                  startX=Math.round((e.clientY-rect.top)/(rect.bottom-rect.top)*{{canvas_size_x}});
                  draggingResizer=anchorHitTest('TOP',startZ,startX);
                  hit = hitImage('TOP',startZ,startX);
                  down = draggingResizer<0 && hit;
                }

                function handleMouseUpFront(e){
                  if (draggingResizer>-1 || draggingImage) {
                      draggingResizer=-1;
                      draggingImage=false;
                      draw();
                  } 
                  down = false;
                }

                function handleMouseUpSide(e){
                  if (draggingResizer>-1 || draggingImage) {
                      draggingResizer=-1;
                      draggingImage=false;
                      draw();
                  }
                  down = false;
                }

                function handleMouseUpTop(e){
                  if (draggingResizer>-1 || draggingImage) {
                      draggingResizer=-1;
                      draggingImage=false;
                      draw();
                  }
                  down = false;
                }

                function handleMouseOutFront(e){
                  if (down)
                    handleMouseUpFront(e);
                }

                function handleMouseOutSide(e){
                  if (down)
                    handleMouseUpSide(e);
                }

                function handleMouseOutTop(e){
                  if (down)
                    handleMouseUpTop(e);
                }

                function handleMouseMoveFront(e){

                  if(draggingResizer>-1){

                      mouseX=parseInt(e.clientX-offsetXFront);
                      mouseY=parseInt(e.clientY-offsetYFront);

                      // resize the image
                      switch(draggingResizer){
                          case 0: //top-left
                              imageX=mouseX;
                              imageWidth=imageRight-mouseX;
                              imageY=mouseY;
                              imageHeight=imageBottom-mouseY;
                              break;
                          case 1: //top-right
                              imageY=mouseY;
                              imageWidth=mouseX-imageX;
                              imageHeight=imageBottom-mouseY;
                              break;
                          case 2: //bottom-right
                              imageWidth=mouseX-imageX;
                              imageHeight=mouseY-imageY;
                              break;
                          case 3: //bottom-left
                              imageX=mouseX;
                              imageWidth=imageRight-mouseX;
                              imageHeight=mouseY-imageY;
                              break;
                      }

                      // enforce minimum dimensions of 25x25
                      if(imageWidth<25){imageWidth=25;}
                      if(imageHeight<25){imageHeight=25;}

                      // set the image right and bottom
                      imageRight=imageX+imageWidth;
                      imageBottom=imageY+imageHeight;

                      // normalize positions
                      prop_x = parseFloat(imageWidth*prop_x)/lastImageWidth;
                      prop_y = parseFloat(imageHeight*prop_y)/lastImageHeight;
                      pos_x = parseInt(prop_x);
                      pos_y = parseInt(prop_y);
                      lastImageWidth = imageWidth;
                      lastImageHeight = imageHeight;

                      // redraw the image with resizing anchors
                      draw();

                  }else if(down){

                      draggingImage = true;

                      imageClick=false;

                      mouseX=parseInt(e.clientX-offsetXFront);
                      mouseY=parseInt(e.clientY-offsetYFront);

                      // move the image by the amount of the latest drag
                      var dx=mouseX-startX;
                      var dy=mouseY-startY;
                      imageX+=dx;
                      imageY+=dy;
                      imageRight+=dx;
                      imageBottom+=dy;
                      // reset the startXY for next time
                      startX=mouseX;
                      startY=mouseY;

                      // redraw the image with border
                      draw();
                  }
                }

                function handleMouseMoveSide(e){

                  if(draggingResizer>-1){

                      mouseX=parseInt(e.clientX-offsetXSide);
                      mouseY=parseInt(e.clientY-offsetYSide);

                      // resize the image
                      switch(draggingResizer){
                          case 0: //top-left
                              imageZ=mouseX;
                              imageDepth=imageBack-mouseX;
                              imageY=mouseY;
                              imageHeight=imageBottom-mouseY;
                              break;
                          case 1: //top-right
                              imageY=mouseY;
                              imageDepth=mouseX-imageZ;
                              imageHeight=imageBottom-mouseY;
                              break;
                          case 2: //bottom-right
                              imageDepth=mouseX-imageZ;
                              imageHeight=mouseY-imageY;
                              break;
                          case 3: //bottom-left
                              imageZ=mouseX;
                              imageDepth=imageBack-mouseX;
                              imageHeight=mouseY-imageY;
                              break;
                      }

                      // enforce minimum dimensions of 25x25
                      if(imageDepth<25){imageDepth=25;}
                      if(imageHeight<25){imageHeight=25;}

                      // set the image right and bottom
                      imageBack=imageZ+imageDepth;
                      imageBottom=imageY+imageHeight;

                      // normalize positions
                      prop_z = parseFloat((imageDepth*prop_z)/lastImageDepth);
                      prop_y = parseFloat((imageHeight*prop_y)/lastImageHeight);
                      pos_z = parseInt(prop_z);
                      pos_y = parseInt(prop_y);
                      lastImageDepth = imageDepth;
                      lastImageHeight = imageHeight;

                      // redraw the image with resizing anchors
                      draw();

                  }else if(down){

                      draggingImage = true;
                      imageClick=false;

                      mouseX=parseInt(e.clientX-offsetXSide);
                      mouseY=parseInt(e.clientY-offsetYSide);

                      // move the image by the amount of the latest drag
                      var dx=mouseX-startZ;
                      var dy=mouseY-startY;
                      imageZ+=dx;
                      imageY+=dy;
                      imageBack+=dx;
                      imageBottom+=dy;
                      // reset the startXY for next time
                      startZ=mouseX;
                      startY=mouseY;

                      // redraw the image with border
                      draw();

                  }
                }

                function handleMouseMoveTop(e){

                  if(draggingResizer>-1){

                      mouseX=parseInt(e.clientX-offsetXTop);
                      mouseY=parseInt(e.clientY-offsetYTop);

                      // resize the image
                      switch(draggingResizer){
                          case 0: //top-left
                              imageX=mouseY;
                              imageDepth=({{canvas_size_z}} - imageZ)-mouseX;
                              imageWidth=imageRight-mouseY;
                              break;
                          case 1: //top-right
                              imageZ={{canvas_size_z}} - mouseX;
                              imageDepth=imageBack-imageZ;
                              imageX=mouseY;
                              imageWidth=imageRight-mouseY;
                              break;
                          case 2: //bottom-right
                              imageZ={{canvas_size_z}} - mouseX;
                              imageWidth=mouseY-imageX;
                              imageDepth=imageBack-imageZ;
                              break;
                          case 3: //bottom-left
                              imageWidth=mouseY-imageX;
                              imageDepth=({{canvas_size_z}} - imageZ)-mouseX;
                              break;
                      }

                      // enforce minimum dimensions of 25x25
                      if(imageWidth<25){imageWidth=25;}
                      if(imageDepth<25){imageDepth=25;}

                      // set the image right and bottom
                      imageRight=imageX+imageWidth;
                      imageBack=imageZ+imageDepth;

                      // normalize positions
                      prop_x = parseFloat((imageWidth*prop_x)/lastImageWidth);
                      prop_z = parseFloat((imageDepth*prop_z)/lastImageDepth);
                      pos_x = parseInt(prop_x);
                      pos_z = parseInt(prop_z);
                      lastImageWidth = imageWidth;
                      lastImageDepth = imageDepth;

                      // redraw the image with resizing anchors
                      draw();

                  }else if(down){

                      imageClick=false;
                      draggingImage = true;

                      mouseX=parseInt(e.clientX-offsetXTop);
                      mouseY=parseInt(e.clientY-offsetYTop);

                      // move the image by the amount of the latest drag
                      var dx=mouseX-startZ;
                      var dy=mouseY-startX;
                      imageX+=dy;
                      imageZ-=dx;
                      imageRight+=dy;
                      imageBack-=dx;
                      // reset the startXY for next time
                      startX=mouseY;
                      startZ=mouseX;

                      // redraw the image with border
                      draw();
                  }
                }
                 function handleClickFront(e){

                    var rect = canvas_front.getBoundingClientRect();
                    mouseX=Math.round((e.clientX-rect.left)/(rect.right-rect.left)*{{canvas_size_x}});
                    mouseY=Math.round((e.clientY-rect.top)/(rect.bottom-rect.top)*{{canvas_size_y}});

                    {% if selected_view != 'BRAIN' %}
                        pos_x_atlas_form.value = mouseX;
                        pos_y_atlas_form.value = mouseY;
                        {% if selected_view == 'ATLAS' %}
                            pos_x_atlas = mouseX;
                            pos_y_atlas = mouseY;
                        {% endif %}
                    {% else %}
                        pos_x_form.value = mouseX;
                        pos_y_form.value = mouseY;
                        pos_x = mouseX;
                        pos_y = mouseY;
                        pos_y = mouseY;
                    {% endif %}
                    info_form.submit();

                }

                function handleClickSide(e){
                    mouseX=parseInt(e.clientX-offsetXSide);
                    mouseY=parseInt(e.clientY-offsetYSide);
                    {% if selected_view != 'BRAIN' %}
                        pos_z_atlas_form.value = mouseX;
                        pos_y_atlas_form.value = mouseY;
                        {% if selected_view == 'ATLAS' %}
                            pos_z_atlas = mouseX;
                            pos_y_atlas = mouseY;
                        {% endif %}
                    {% else %}
                        pos_z_form.value = mouseX;
                        pos_y_form.value = mouseY;
                        pos_z = mouseX;
                        pos_y = mouseY;
                    {% endif %}
                    info_form.submit();
                }

                function handleClickTop(e){
                    mouseX=parseInt(e.clientX-offsetXTop);
                    mouseY=parseInt(e.clientY-offsetYTop);
                    {% if selected_view != 'BRAIN' %}
                        pos_z_atlas_form.value = {{canvas_size_z}} - mouseX;
                        pos_x_atlas_form.value = mouseY;
                        {% if selected_view == 'ATLAS' %}
                            pos_z_atlas = {{canvas_size_z}} - mouseX;
                            pos_x_atlas = mouseY;
                        {% endif %}
                    {% else %}
                        pos_z_form.value = {{canvas_size_z}} - mouseX;
                        pos_x_form.value = mouseY;
                        pos_z = {{canvas_size_z}} - mouseX;
                        pos_x = mouseY;
                    {% endif %}
                    info_form.submit();
                }
                </script>

        </div>
{% endblock %}
